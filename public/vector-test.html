<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘é‡åµŒå…¥æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        button {
            background-color: #00ED64;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #00d45a;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success {
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        .info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        .character-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .similarity-score {
            background: #00ED64;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            float: right;
        }
        select {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¢ å‘é‡åµŒå…¥æ¸¬è©¦å·¥å…·</h1>
        
        <!-- ç”Ÿæˆå‘é‡åµŒå…¥ -->
        <div class="section">
            <h2>ğŸ”„ ç”Ÿæˆå‘é‡åµŒå…¥</h2>
            <button onclick="generateEmbeddings()">ç”Ÿæˆæ‰€æœ‰äººç‰©å‘é‡</button>
            <div id="generateResult" class="result" style="display: none;"></div>
        </div>

        <!-- ç›¸ä¼¼äººç‰©æœå°‹ -->
        <div class="section">
            <h2>ğŸ” ç›¸ä¼¼äººç‰©æœå°‹</h2>
            <div>
                <select id="characterSelect">
                    <option value="">é¸æ“‡äººç‰©...</option>
                    <option value="ABR001">äºä¼¯æ‹‰ç½• (Abraham)</option>
                    <option value="MOS002">æ‘©è¥¿ (Moses)</option>
                    <option value="DAV003">å¤§è¡› (David)</option>
                    <option value="PET004">å½¼å¾— (Peter)</option>
                    <option value="PAU005">ä¿ç¾… (Paul)</option>
                    <option value="MAR006">é¦¬åˆ©äº (Mary)</option>
                    <option value="JOS007">ç´„ç‘Ÿ (Joseph)</option>
                    <option value="DAN008">ä½†ä»¥ç† (Daniel)</option>
                    <option value="ZAC009">æ’’è©² (Zacchaeus)</option>
                    <option value="TAB010">å¤šåŠ  (Tabitha)</option>
                </select>
                <select id="limitSelect">
                    <option value="3">é¡¯ç¤ºå‰ 3 å€‹</option>
                    <option value="5" selected>é¡¯ç¤ºå‰ 5 å€‹</option>
                    <option value="10">é¡¯ç¤ºå‰ 10 å€‹</option>
                </select>
                <button onclick="findSimilar()">æœå°‹ç›¸ä¼¼äººç‰©</button>
            </div>
            <div id="similarResult" class="result" style="display: none;"></div>
        </div>

        <!-- æ¸¬è©¦åŠŸèƒ½ -->
        <div class="section">
            <h2>ğŸ§ª å¿«é€Ÿæ¸¬è©¦</h2>
            <button onclick="testAPI()">æ¸¬è©¦ API é€£æ¥</button>
            <button onclick="listCharacters()">åˆ—å‡ºæ‰€æœ‰äººç‰©</button>
            <div id="testResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        async function generateEmbeddings() {
            const result = document.getElementById('generateResult');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = 'ğŸ”„ æ­£åœ¨ç”Ÿæˆå‘é‡åµŒå…¥...';

            try {
                const response = await fetch('/api/vector/embeddings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.ok) {
                    result.className = 'result success';
                    result.textContent = `âœ… ${data.message}\n\n`;
                    if (data.characters && data.characters.length > 0) {
                        result.textContent += `ç”Ÿæˆçš„äººç‰©:\n`;
                        data.characters.forEach(char => {
                            result.textContent += `- ${char.character_name.chinese} (${char.character_name.english})\n`;
                        });
                    }
                } else {
                    result.className = 'result error';
                    result.textContent = `âŒ éŒ¯èª¤: ${data.error}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`;
            }
        }

        async function findSimilar() {
            const characterId = document.getElementById('characterSelect').value;
            const limit = document.getElementById('limitSelect').value;
            const result = document.getElementById('similarResult');

            if (!characterId) {
                result.style.display = 'block';
                result.className = 'result error';
                result.textContent = 'âŒ è«‹å…ˆé¸æ“‡ä¸€å€‹äººç‰©';
                return;
            }

            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = 'ğŸ” æ­£åœ¨æœå°‹ç›¸ä¼¼äººç‰©...';

            try {
                const response = await fetch(`/api/vector/embeddings?characterId=${characterId}&limit=${limit}`);
                const data = await response.json();

                if (data.ok) {
                    result.className = 'result success';
                    let html = `<h3>èˆ‡ ${getCharacterName(data.characterId)} ç›¸ä¼¼çš„äººç‰©:</h3>`;
                    
                    if (data.similarCharacters && data.similarCharacters.length > 0) {
                        data.similarCharacters.forEach(char => {
                            html += `
                                <div class="character-card">
                                    <span class="similarity-score">ç›¸ä¼¼åº¦: ${(char.similarity * 100).toFixed(1)}%</span>
                                    <strong>${char.character_name.chinese}</strong> (${char.character_name.english})
                                    <br><small>ID: ${char.character_id}</small>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p>æ²’æœ‰æ‰¾åˆ°ç›¸ä¼¼çš„äººç‰©</p>';
                    }
                    
                    result.innerHTML = html;
                } else {
                    result.className = 'result error';
                    result.textContent = `âŒ éŒ¯èª¤: ${data.error}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`;
            }
        }

        async function testAPI() {
            const result = document.getElementById('testResult');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦ API é€£æ¥...';

            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                result.className = 'result success';
                result.textContent = `âœ… API é€£æ¥æ­£å¸¸\n\nå›æ‡‰: ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ API é€£æ¥å¤±æ•—: ${error.message}`;
            }
        }

        async function listCharacters() {
            const result = document.getElementById('testResult');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = 'ğŸ”„ æ­£åœ¨ç²å–äººç‰©åˆ—è¡¨...';

            try {
                // å‡è¨­æœ‰ç²å–äººç‰©åˆ—è¡¨çš„ API
                const response = await fetch('/api/personas');
                const data = await response.json();

                if (data.ok && data.characters) {
                    result.className = 'result success';
                    let text = `âœ… æ‰¾åˆ° ${data.characters.length} å€‹äººç‰©:\n\n`;
                    data.characters.forEach(char => {
                        text += `- ${char.character_name.chinese} (${char.character_name.english}) [${char.character_id}]\n`;
                    });
                    result.textContent = text;
                } else {
                    result.className = 'result error';
                    result.textContent = `âŒ éŒ¯èª¤: ${data.error || 'ç„¡æ³•ç²å–äººç‰©åˆ—è¡¨'}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`;
            }
        }

        function getCharacterName(characterId) {
            const names = {
                'ABR001': 'äºä¼¯æ‹‰ç½•',
                'MOS002': 'æ‘©è¥¿',
                'DAV003': 'å¤§è¡›',
                'PET004': 'å½¼å¾—',
                'PAU005': 'ä¿ç¾…',
                'MAR006': 'é¦¬åˆ©äº',
                'JOS007': 'ç´„ç‘Ÿ',
                'DAN008': 'ä½†ä»¥ç†',
                'ZAC009': 'æ’’è©²',
                'TAB010': 'å¤šåŠ '
            };
            return names[characterId] || characterId;
        }
    </script>
</body>
</html>